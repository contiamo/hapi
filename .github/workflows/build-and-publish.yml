name: Build and Publish

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    name: Build and Publish
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - run: bun install
      - run: bun run build:single-exe:all

      - name: Package Release Artifacts
        run: |
          cd cli/dist-exe
          mkdir -p ../release-artifacts

          for dir in bun-*/; do
              target="${dir%/}"
              # bun-darwin-arm64 -> hapi-darwin-arm64
              name="hapi-${target#bun-}"
              name="${name/windows/win32}"

              if [[ "$target" == *"windows"* ]]; then
                  zip -j "../release-artifacts/${name}.zip" "$target"/hapi.exe
              else
                  tar -czvf "../release-artifacts/${name}.tar.gz" -C "$target" hapi
              fi
          done

          cd ../release-artifacts
          sha256sum * > checksums.txt

      - name: Publish Release Artefacts
        env:
          GITHUB_TOKEN: ${{ secrets.CONTIAMO_CI_TOKEN }}
        run: gh release upload "${{ github.event.release.tag_name }}" cli/release-artifacts/*
