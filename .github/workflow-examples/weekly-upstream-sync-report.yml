name: Weekly Upstream Sync Report

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    # Allow manual trigger

jobs:
  generate-report:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/tiann/hapi || true
          git remote -v

      - name: Fetch upstream
        run: git fetch upstream main

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Generate upstream sync report
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          uv run scripts/generate-upstream-sync-report.py

      - name: Check if report was generated
        id: check_report
        run: |
          if [ -f UPSTREAM_SYNC_REPORT.md ]; then
            echo "report_exists=true" >> $GITHUB_OUTPUT
            # Get first 50 lines for issue preview
            echo "preview<<EOF" >> $GITHUB_OUTPUT
            head -100 UPSTREAM_SYNC_REPORT.md >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "report_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload report as artifact
        if: steps.check_report.outputs.report_exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: upstream-sync-report-${{ github.run_number }}
          path: UPSTREAM_SYNC_REPORT.md
          retention-days: 30

      - name: Create or update issue
        if: steps.check_report.outputs.report_exists == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('UPSTREAM_SYNC_REPORT.md', 'utf8');

            // Search for existing open upstream sync issues
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'upstream-sync',
              sort: 'created',
              direction: 'desc',
              per_page: 1
            });

            const title = `Weekly Upstream Sync Report - ${new Date().toISOString().split('T')[0]}`;

            // Create issue body with report
            const body = `## ðŸ“¦ Upstream Sync Report Available

A new upstream sync analysis has been generated.

### Quick Actions

- ðŸ“¥ [Download full report artifact](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
- ðŸ“– [Read upstream sync strategy](../blob/main/UPSTREAM_SYNC_STRATEGY.md)
- ðŸ“ [View sync log](../blob/main/UPSTREAM_SYNC_LOG.md)

### Report Preview

\`\`\`markdown
${report.slice(0, 3000)}
${report.length > 3000 ? '\n... (truncated, see artifact for full report)' : ''}
\`\`\`

---

### ðŸ“‹ Next Steps Checklist

After reviewing the full report:

- [ ] Review executive summary table
- [ ] Identify Phase 1 quick wins (ðŸŸ¢ Low risk)
- [ ] Create sync branch: \`git checkout -b upstream-sync-$(date +%Y-%m-%d)\`
- [ ] Execute Phase 1 backports
- [ ] Run tests: \`pnpm test\`
- [ ] Update [UPSTREAM_SYNC_LOG.md](../blob/main/UPSTREAM_SYNC_LOG.md)
- [ ] Create PR with changes
- [ ] Close this issue

### ðŸ¤– Automation

This report was automatically generated by the [weekly upstream sync workflow](../blob/main/.github/workflows/weekly-upstream-sync-report.yml).

**Report generated**: ${new Date().toISOString()}
**Workflow run**: https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}
`;

            // Check if we should update existing issue or create new
            const existingIssue = issues.data[0];
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);

            if (existingIssue && new Date(existingIssue.created_at) > oneWeekAgo) {
              // Update existing recent issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                title: title,
                body: body
              });

              // Add comment about update
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `ðŸ”„ **Report updated** - ${new Date().toISOString().split('T')[0]}\n\nA new analysis has been generated. See the updated report above.`
              });

              core.info(`Updated existing issue #${existingIssue.number}`);
            } else {
              // Create new issue
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['upstream-sync', 'automated']
              });

              core.info(`Created new issue #${issue.data.number}`);
            }

      - name: Post summary
        if: steps.check_report.outputs.report_exists == 'true'
        run: |
          echo "## âœ… Upstream Sync Report Generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "A new upstream sync analysis has been completed." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“Š **Workflow Run**: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¥ **Artifact**: upstream-sync-report-${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”— **Issue**: Check repository issues for new upstream-sync issue" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Report Preview" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          head -50 UPSTREAM_SYNC_REPORT.md >> $GITHUB_STEP_SUMMARY
          echo "..." >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Report generation failed
        if: steps.check_report.outputs.report_exists == 'false'
        run: |
          echo "::error::Failed to generate report"
          echo "## âŒ Report Generation Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The upstream sync report could not be generated." >> $GITHUB_STEP_SUMMARY
          echo "Check the workflow logs for details." >> $GITHUB_STEP_SUMMARY
          exit 1
